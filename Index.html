<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reservas - Cine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        /* Sección de Asientos */
        .asientos-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }

        .pantalla {
            background: #333;
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .asientos-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .fila-label {
            grid-column: 1 / -1;
            text-align: center;
            font-weight: bold;
            color: #666;
            margin: 10px 0 5px 0;
            padding: 5px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .asiento {
            width: 35px;
            height: 35px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            position: relative;
        }

        .asiento.libre {
            background: #28a745;
            color: white;
            border-color: #1e7e34;
        }

        .asiento.libre:hover {
            background: #34ce57;
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.4);
        }

        .asiento.ocupado {
            background: #dc3545;
            color: white;
            border-color: #c82333;
            cursor: not-allowed;
        }

        .asiento.seleccionado {
            background: #ffc107;
            color: #212529;
            border-color: #e0a800;
            transform: scale(1.1);
            box-shadow: 0 3px 15px rgba(255, 193, 7, 0.5);
        }

        .leyenda {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .leyenda-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .leyenda-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #333;
        }

        /* Sección de Comida */
        .comida-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }

        .comida-grid {
            display: grid;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .comida-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comida-item:hover {
            border-color: #007bff;
            box-shadow: 0 3px 10px rgba(0, 123, 255, 0.2);
            transform: translateY(-2px);
        }

        .comida-item.seleccionado {
            border-color: #28a745;
            background: #d4edda;
        }

        .comida-info {
            flex: 1;
        }

        .comida-nombre {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .comida-precio {
            color: #007bff;
            font-size: 1.1em;
            font-weight: bold;
        }

        .cantidad-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cantidad-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .cantidad-btn:hover {
            background: #0056b3;
        }

        .cantidad-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .cantidad {
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        /* Resumen */
        .resumen {
            grid-column: 1 / -1;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .resumen h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .resumen-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .resumen-asientos, .resumen-comida {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .resumen-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .total {
            border-top: 2px solid rgba(255, 255, 255, 0.3);
            padding-top: 15px;
            margin-top: 15px;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
        }

        .btn-reservar {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            width: 100%;
        }

        .btn-reservar:hover {
            background: #ee5a24;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(238, 90, 36, 0.4);
        }

        .btn-reservar:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            color: #dc3545;
            text-align: center;
            padding: 15px;
            background: #f8d7da;
            border-radius: 10px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .resumen-content {
                grid-template-columns: 1fr;
            }
            
            .asientos-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 Cinelandia</h1>
            <p>Selecciona tus asientos y disfruta de nuestros deliciosos snacks</p>
        </div>

        <div class="main-content">
            <!-- Sección de Asientos -->
            <div class="asientos-section">
                <h2>🪑 Selección de Asientos</h2>
                
                <div class="pantalla">
                    🎬 PANTALLA
                </div>

                <div id="asientos-loading" class="loading">Cargando asientos...</div>
                <div id="asientos-container" style="display: none;">
                    <div id="asientos-grid" class="asientos-grid"></div>
                    
                    <div class="leyenda">
                        <div class="leyenda-item">
                            <div class="leyenda-color" style="background: #28a745;"></div>
                            <span>Disponible</span>
                        </div>
                        <div class="leyenda-item">
                            <div class="leyenda-color" style="background: #ffc107;"></div>
                            <span>Seleccionado</span>
                        </div>
                        <div class="leyenda-item">
                            <div class="leyenda-color" style="background: #dc3545;"></div>
                            <span>Ocupado</span>
                        </div>
                    </div>
                </div>
                <div id="asientos-error" class="error" style="display: none;"></div>
            </div>

            <!-- Sección de Comida -->
            <div class="comida-section">
                <h2>🍿 Selección de Comida</h2>
                
                <div id="comida-loading" class="loading">Cargando menú...</div>
                <div id="comida-container" style="display: none;">
                    <div id="comida-grid" class="comida-grid"></div>
                </div>
                <div id="comida-error" class="error" style="display: none;"></div>
            </div>
        </div>

        <!-- Resumen -->
        <div class="resumen">
            <h3>📋 Resumen de tu Reserva</h3>
            <div class="resumen-content">
                <div class="resumen-asientos">
                    <h4>Asientos Seleccionados:</h4>
                    <div id="resumen-asientos">Ningún asiento seleccionado</div>
                </div>
                <div class="resumen-comida">
                    <h4>Comida Seleccionada:</h4>
                    <div id="resumen-comida">Ningún item seleccionado</div>
                </div>
            </div>
            <div class="total">
                Total: $<span id="total-precio">0</span>
            </div>
            <button id="btn-reservar" class="btn-reservar" disabled>Realizar Reserva</button>
        </div>
    </div>

    <script>
      const estado = {
            asientos: [],
            alimentos: [],
            asientosSeleccionados: [],
            alimentosSeleccionados: {}
        };

        // Precio base por asiento
        const PRECIO_ASIENTO = 15000;

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            cargarAsientos();
            cargarAlimentos();
        });

        // Función para cargar asientos
        async function cargarAsientos() {
            try {
                const response = await fetch("http://localhost:8082/asientos/api/asientos");
                if (!response.ok) throw new Error("Error al cargar asientos");
                estado.asientos = await response.json();
                mostrarAsientos();
            } catch (error) {
                console.error(error);
                document.getElementById("asientos-error").style.display = "block";
                document.getElementById("asientos-error").textContent = "No se pudieron cargar los asientos.";
            }
        }

        // Función para mostrar asientos
        function mostrarAsientos() {
            document.getElementById('asientos-loading').style.display = 'none';
            document.getElementById('asientos-container').style.display = 'block';
            
            const grid = document.getElementById('asientos-grid');
            grid.innerHTML = '';
            
            // Agrupar asientos por fila
            const asientosPorFila = {};
            estado.asientos.forEach(asiento => {
                if (!asientosPorFila[asiento.fila]) {
                    asientosPorFila[asiento.fila] = [];
                }
                asientosPorFila[asiento.fila].push(asiento);
            });
            
            // Crear elementos para cada fila
            Object.keys(asientosPorFila).sort().forEach(fila => {
                // Etiqueta de fila
                const filaLabel = document.createElement('div');
                filaLabel.className = 'fila-label';
                filaLabel.textContent = `Fila ${fila}`;
                grid.appendChild(filaLabel);
                
                // Asientos de la fila
                asientosPorFila[fila]
                    .sort((a, b) => parseInt(a.numero) - parseInt(b.numero))
                    .forEach(asiento => {
                        const asientoEl = document.createElement('div');
                        asientoEl.className = 'asiento';
                        asientoEl.textContent = asiento.numero;
                        asientoEl.dataset.id = asiento.id;
                        
                        if (asiento.ocupado) {
                            asientoEl.classList.add('ocupado');
                        } else {
                            asientoEl.classList.add('libre');
                            asientoEl.addEventListener('click', () => toggleAsiento(asiento));
                        }
                        
                        grid.appendChild(asientoEl);
                    });
            });
        }

        // Función para alternar selección de asiento
        function toggleAsiento(asiento) {
            const index = estado.asientosSeleccionados.findIndex(a => a.id === asiento.id);
            const asientoEl = document.querySelector(`[data-id="${asiento.id}"]`);
            
            if (index > -1) {
                // Deseleccionar
                estado.asientosSeleccionados.splice(index, 1);
                asientoEl.classList.remove('seleccionado');
                asientoEl.classList.add('libre');
            } else {
                // Seleccionar
                estado.asientosSeleccionados.push(asiento);
                asientoEl.classList.remove('libre');
                asientoEl.classList.add('seleccionado');
            }
            
            actualizarResumen();
        }

        // Función para cargar alimentos
        async function cargarAlimentos() {
            // Usar directamente datos de demostración
            console.log('Cargando alimentos con datos de demostración...');
            crearAlimentosDemostracion();
        }

        // Función para crear alimentos de demostración
        function crearAlimentosDemostracion() {
            estado.alimentos = [
                { id: 1, nombre: "Palomitas Grandes", precio: 12000 },
                { id: 2, nombre: "Palomitas Medianas", precio: 8000 },
                { id: 3, nombre: "Palomitas Pequeñas", precio: 5000 },
                { id: 4, nombre: "Gaseosa Grande", precio: 8000 },
                { id: 5, nombre: "Gaseosa Mediana", precio: 6000 },
                { id: 6, nombre: "Agua", precio: 3000 },
                { id: 7, nombre: "Nachos con Queso", precio: 15000 },
                { id: 8, nombre: "Hot Dog", precio: 12000 },
                { id: 9, nombre: "Hamburguesa", precio: 18000 },
                { id: 10, nombre: "Combo Palomitas + Gaseosa", precio: 18000 },
                { id: 11, nombre: "Dulces Variados", precio: 4000 },
                { id: 12, nombre: "Chocolate", precio: 5000 },
                { id: 13, nombre: "Café", precio: 4000 },
                { id: 14, nombre: "Té Helado", precio: 5000 },
                { id: 15, nombre: "Pizza Personal", precio: 16000 }
            ];
            
            mostrarAlimentos();
        }

        // Función para mostrar alimentos
        function mostrarAlimentos() {
            document.getElementById('comida-loading').style.display = 'none';
            document.getElementById('comida-container').style.display = 'block';
            
            const grid = document.getElementById('comida-grid');
            grid.innerHTML = '';
            
            estado.alimentos.forEach(alimento => {
                const item = document.createElement('div');
                item.className = 'comida-item';
                item.innerHTML = `
                    <div class="comida-info">
                        <div class="comida-nombre">${alimento.nombre}</div>
                        <div class="comida-precio">$${alimento.precio.toLocaleString('es-CO')}</div>
                    </div>
                    <div class="cantidad-control">
                        <button class="cantidad-btn" onclick="cambiarCantidad(${alimento.id}, -1)">-</button>
                        <span class="cantidad" id="cantidad-${alimento.id}">0</span>
                        <button class="cantidad-btn" onclick="cambiarCantidad(${alimento.id}, 1)">+</button>
                    </div>
                `;
                
                grid.appendChild(item);
            });
        }

        // Función para cambiar cantidad de alimento
        function cambiarCantidad(alimentoId, cambio) {
            const cantidadActual = estado.alimentosSeleccionados[alimentoId] || 0;
            const nuevaCantidad = Math.max(0, cantidadActual + cambio);
            
            if (nuevaCantidad === 0) {
                delete estado.alimentosSeleccionados[alimentoId];
            } else {
                estado.alimentosSeleccionados[alimentoId] = nuevaCantidad;
            }
            
            // Actualizar UI
            document.getElementById(`cantidad-${alimentoId}`).textContent = nuevaCantidad;
            
            // Actualizar estilo del item
            const item = document.getElementById(`cantidad-${alimentoId}`).closest('.comida-item');
            if (nuevaCantidad > 0) {
                item.classList.add('seleccionado');
            } else {
                item.classList.remove('seleccionado');
            }
            
            actualizarResumen();
        }

        // Función para actualizar el resumen
        function actualizarResumen() {
            // Resumen de asientos
            const resumenAsientos = document.getElementById('resumen-asientos');
            if (estado.asientosSeleccionados.length === 0) {
                resumenAsientos.textContent = 'Ningún asiento seleccionado';
            } else {
                resumenAsientos.innerHTML = estado.asientosSeleccionados
                    .map(asiento => `<div class="resumen-item"><span>Fila ${asiento.fila}, Asiento ${asiento.numero}</span><span>$${PRECIO_ASIENTO.toLocaleString('es-CO')}</span></div>`)
                    .join('');
            }
            
            // Resumen de comida
            const resumenComida = document.getElementById('resumen-comida');
            const alimentosSeleccionados = Object.keys(estado.alimentosSeleccionados);
            
            if (alimentosSeleccionados.length === 0) {
                resumenComida.textContent = 'Ningún item seleccionado';
            } else {
                resumenComida.innerHTML = alimentosSeleccionados
                    .map(id => {
                        const alimento = estado.alimentos.find(a => a.id == id);
                        const cantidad = estado.alimentosSeleccionados[id];
                        const subtotal = alimento.precio * cantidad;
                        return `<div class="resumen-item"><span>${alimento.nombre} x${cantidad}</span><span>$${subtotal.toLocaleString('es-CO')}</span></div>`;
                    })
                    .join('');
            }
            
            // Calcular total
            const totalAsientos = estado.asientosSeleccionados.length * PRECIO_ASIENTO;
            const totalComida = Object.keys(estado.alimentosSeleccionados).reduce((total, id) => {
                const alimento = estado.alimentos.find(a => a.id == id);
                return total + (alimento.precio * estado.alimentosSeleccionados[id]);
            }, 0);
            
            const totalGeneral = totalAsientos + totalComida;
            document.getElementById('total-precio').textContent = totalGeneral.toLocaleString('es-CO');
            
            // Habilitar/deshabilitar botón de reserva
            const btnReservar = document.getElementById('btn-reservar');
            btnReservar.disabled = estado.asientosSeleccionados.length === 0;
        }

        // Función para realizar reserva
        document.getElementById('btn-reservar').addEventListener('click', async () => {
            if (estado.asientosSeleccionados.length === 0) {
                alert('Debes seleccionar al menos un asiento');
                return;
            }
            
            const confirmacion = confirm('¿Confirmas tu reserva?');
            if (!confirmacion) return;
            
            // Deshabilitar el botón durante la reserva
            const btnReservar = document.getElementById('btn-reservar');
            btnReservar.disabled = true;
            btnReservar.textContent = 'Procesando...';
            
            try {
                const idsAsientos = estado.asientosSeleccionados.map(a => a.id);

                const response = await fetch("http://localhost:8082/asientos/reservar", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(idsAsientos)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }

                const asientosReservados = await response.json();
                
                alert(`¡Reserva realizada con éxito!\n\nAsientos reservados: ${asientosReservados.length}\nTotal: $${document.getElementById('total-precio').textContent}`);

                // Limpiar selecciones
                estado.asientosSeleccionados = [];
                estado.alimentosSeleccionados = {};
                
                // Recargar datos
                await cargarAsientos();
                cargarAlimentos();
                actualizarResumen();
                
            } catch (error) {
                console.error("Error:", error);
                alert(`Error al realizar la reserva: ${error.message}`);
            } finally {
                // Rehabilitar el botón
                btnReservar.disabled = estado.asientosSeleccionados.length === 0;
                btnReservar.textContent = 'Realizar Reserva';
            }
        });
    </script>
</body>
</html>